# PawPal AI 测试用例文档

> **版本**: v1.5  
> **更新日期**: 2026-02-06  
> **覆盖模块**: 智能问卷、智能匹配、AI预审  
> **状态**: 已开发完成 | 测试验证阶段  

---

## 目录

1. [智能问卷测试](#1-智能问卷测试)
2. [智能匹配测试](#2-智能匹配测试)
3. [AI预审测试](#3-ai预审测试)
4. [集成测试](#4-集成测试)
5. [性能测试](#5-性能测试)

---

## 1. 智能问卷测试

### 1.1 功能测试

#### TC-Q-001: 首次启动问卷

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证问卷首次启动正常 |
| **前置条件** | 用户已登录 |
| **测试步骤** | 1. 访问 /ai-questionnaire<br>2. 等待AI响应 |
| **预期结果** | 1. 显示欢迎消息<br>2. AI提出第一个问题<br>3. 显示3-4个选项 |
| **优先级** | P0 |

#### TC-Q-002: 正常对话流程

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证多轮对话正常进行 |
| **前置条件** | 问卷已启动 |
| **测试数据** | 用户回答："公寓"、"没有经验"、"2小时"、"独居"、"喜欢安静的" |
| **测试步骤** | 1. 依次回答5个问题<br>2. 观察每个响应 |
| **预期结果** | 1. 每个回答后AI立即响应<br>2. 问题之间有逻辑关联<br>3. 每问都有explanation |
| **优先级** | P0 |

#### TC-Q-003: 问卷完成流程

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证问卷完成后的跳转 |
| **前置条件** | 已完成6-8轮对话 |
| **测试步骤** | 1. 回答最后一个问题<br>2. 等待完成提示<br>3. 观察页面跳转 |
| **预期结果** | 1. 显示完成消息<br>2. 2秒后自动跳转到推荐页面<br>3. 携带profile数据 |
| **优先级** | P0 |

#### TC-Q-004: 跳过问题功能

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证跳过功能正常 |
| **前置条件** | 问卷进行中 |
| **测试步骤** | 1. 点击"跳过此问题"<br>2. 观察AI响应 |
| **预期结果** | 1. AI收到"跳过"作为回答<br>2. 继续下一个问题<br>3. 不崩溃 |
| **优先级** | P1 |

#### TC-Q-005: LLM失败Fallback

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证LLM失败时的Mock Fallback |
| **前置条件** | 断开LLM API连接或设置错误API Key |
| **测试步骤** | 1. 启动问卷<br>2. 回答问题 |
| **预期结果** | 1. 使用Mock问题库<br>2. 对话正常进行<br>3. 日志记录Fallback事件 |
| **优先级** | P1 |

### 1.2 边界测试

#### TC-Q-006: 超长输入处理

| 项目 | 内容 |
|------|------|
| **测试数据** | 500字以上的超长回答 |
| **预期结果** | 正常处理，不截断关键信息 |
| **优先级** | P2 |

#### TC-Q-007: 特殊字符输入

| 项目 | 内容 |
|------|------|
| **测试数据** | `<script>alert('xss')</script>`、emoji、SQL注入语句 |
| **预期结果** | 正常处理，无安全漏洞 |
| **优先级** | P1 |

#### TC-Q-008: 快速连续点击

| 项目 | 内容 |
|------|------|
| **测试步骤** | 快速连续点击发送按钮10次 |
| **预期结果** | 只处理第一次点击，后续忽略 |
| **优先级** | P2 |

### 1.3 画像提取测试

#### TC-Q-009: 标准画像提取

| 项目 | 内容 |
|------|------|
| **测试数据** | 完整8轮对话 |
| **验证点** | 提取的20维画像字段完整且准确 |
| **预期结果** | living_space=apartment, experience_level=none, daily_time_available=2... |
| **优先级** | P0 |

#### TC-Q-010: 不完整对话提取

| 项目 | 内容 |
|------|------|
| **测试数据** | 仅3轮对话 |
| **验证点** | 未提及字段使用默认值 |
| **预期结果** | 已收集字段准确，未收集字段为null或默认值 |
| **优先级** | P1 |

---

## 2. 智能匹配测试

### 2.1 功能测试

#### TC-M-001: 标准匹配流程

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证标准匹配流程 |
| **前置条件** | 已完成问卷获取profile |
| **测试步骤** | 1. 进入推荐页面<br>2. 等待匹配结果 |
| **预期结果** | 1. 显示3个推荐宠物<br>2. 每个有匹配分数<br>3. 有匹配理由和顾虑 |
| **优先级** | P0 |

#### TC-M-002: 完美匹配场景

| 项目 | 内容 |
|------|------|
| **测试数据** | 用户：大房子、经验丰富、时间充足<br>宠物：大型犬、高能量 |
| **预期结果** | 匹配分数 > 85分<br>显示"完美匹配"标识 |
| **优先级** | P1 |

#### TC-M-003: 不匹配场景

| 项目 | 内容 |
|------|------|
| **测试数据** | 用户：小公寓、新手、时间少<br>宠物：大型犬、高能量 |
| **预期结果** | 匹配分数 < 60分<br>显示"不太匹配"警告<br>列出具体顾虑 |
| **优先级** | P1 |

#### TC-M-004: 硬性条件一票否决

| 项目 | 内容 |
|------|------|
| **测试数据** | 用户：租房且房东不允许<br>宠物：任意 |
| **预期结果** | passed_hard_constraints = false<br>总分大幅降低 |
| **优先级** | P1 |

#### TC-M-005: Embedding服务失败Fallback

| 项目 | 内容 |
|------|------|
| **前置条件** | 断开Embedding服务 |
| **测试步骤** | 请求匹配推荐 |
| **预期结果** | 使用简化规则匹配<br>返回结果正常 |
| **优先级** | P1 |

### 2.2 算法测试

#### TC-M-006: 硬性规则验证

| 规则 | 测试数据 | 预期结果 |
|------|----------|----------|
| 空间-体型 | 小公寓+大型犬 | 失败 |
| 空间-体型 | 别墅+大型犬 | 通过 |
| 经验-难度 | 新手+难训练 | 失败 |
| 时间-运动 | 1小时+高运动需求 | 失败 |
| 掉毛容忍 | 不接受掉毛+高掉毛 | 失败 |

#### TC-M-007: 权重计算验证

| 项目 | 内容 |
|------|------|
| **测试数据** | hard=100, soft=80, historical=50 |
| **计算公式** | 0.4×100 + 0.4×80 + 0.2×50 = 82 |
| **预期结果** | overall_score = 82 |
| **优先级** | P1 |

#### TC-M-008: 排序验证

| 项目 | 内容 |
|------|------|
| **测试数据** | 5只宠物，不同匹配分数 |
| **预期结果** | 按分数降序排列<br>硬性未通过的排在最后 |
| **优先级** | P1 |

### 2.3 前端展示测试

#### TC-M-009: 分数颜色显示

| 分数 | 预期颜色 |
|------|----------|
| 90 | 绿色 |
| 75 | 黄色 |
| 50 | 橙色 |

#### TC-M-010: 空状态处理

| 项目 | 内容 |
|------|------|
| **前置条件** | 无可领养宠物 |
| **预期结果** | 显示"暂无推荐"提示<br>提供浏览全部入口 |
| **优先级** | P2 |

---

## 3. AI预审测试

### 3.1 功能测试

#### TC-P-001: 预审会话启动

| 项目 | 内容 |
|------|------|
| **测试目的** | 验证预审会话正常启动 |
| **测试步骤** | 1. 在宠物详情页点击"开始预审"<br>2. 等待AI响应 |
| **预期结果** | 1. 生成session_id<br>2. AI发送开场白<br>3. 提出第一个问题 |
| **优先级** | P0 |

#### TC-P-002: 正常预审流程

| 项目 | 内容 |
|------|------|
| **测试步骤** | 依次回答所有预审问题 |
| **预期结果** | 1. 状态机正常流转<br>2. 收集数据完整<br>3. 最终生成总结 |
| **优先级** | P0 |

#### TC-P-003: 低风险用户通过

| 项目 | 内容 |
|------|------|
| **测试数据** | 稳定工作、自有住房、经验丰富、时间充足 |
| **预期结果** | 分数 ≥ 80<br>建议"申请通过" |
| **优先级** | P1 |

#### TC-P-004: 高风险用户拒绝

| 项目 | 内容 |
|------|------|
| **测试数据** | 学生、租房无许可、经常出差、无经验 |
| **预期结果** | 分数 < 60<br>建议"改善后再申请"<br>列出风险点 |
| **优先级** | P1 |

#### TC-P-005: 风险澄清流程

| 项目 | 内容 |
|------|------|
| **测试步骤** | 1. 触发风险点（如工作时间长）<br>2. AI提出澄清问题<br>3. 提供合理解释 |
| **预期结果** | 1. 进入RISK_CLARIFICATION状态<br>2. 澄清后风险标记为resolved<br>3. 分数相应增加 |
| **优先级** | P1 |

### 3.2 风险点检测测试

#### TC-P-006: 风险点识别

| 风险ID | 触发条件 | 预期识别 |
|--------|----------|----------|
| R001 | 职业="学生" | ✓ |
| R003 | is_renting=true, landlord_allows_pets=false | ✓ |
| R006 | work_hours_per_day=12, has_caretaker=false | ✓ |
| R011 | family_status=with_kids_young, preferred_energy=high | ✓ |
| R016 | reason包含"看门" | ✓ |

#### TC-P-007: 风险评分计算

| 风险组合 | 预期分数 |
|----------|----------|
| 无风险 | 100 |
| 1个高风险 | 80 |
| 2个高风险 | 60 |
| 1个高风险+澄清 | 85 |

### 3.3 状态机测试

#### TC-P-008: 状态流转验证

```
INIT → BASIC_INFO → HOUSING_CHECK → INCOME_CHECK → TIME_COMMITMENT
→ EXPERIENCE_CHECK → FAMILY_CHECK → MOTIVATION_CHECK → PREPARATION_CHECK
→ SUMMARY → COMPLETE
```

每个状态转换都需要验证数据正确传递。

---

## 4. 集成测试

### 4.1 端到端流程

#### TC-E2E-001: 完整AI流程

```
登录 → 启动问卷 → 完成8轮对话 → 获取推荐 → 点击推荐 → 开始预审 → 完成预审 → 提交申请
```

**验证点:**
- 每个环节数据正确传递
- 页面跳转正常
- 无数据丢失

### 4.2 API集成测试

#### TC-API-001: 问卷→匹配→预审 数据流

| API调用链 | 验证点 |
|-----------|--------|
| POST /questionnaire/extract-profile | 返回完整profile |
| POST /match/recommendations | 使用上一步的profile |
| POST /precheck/start | 使用推荐的pet_id |

### 4.3 错误恢复测试

#### TC-ERR-001: 网络中断恢复

| 场景 | 预期行为 |
|------|----------|
| 问卷中网络中断 | 显示错误提示，可重试 |
| 匹配请求超时 | 显示加载失败，可刷新 |
| 预审会话过期 | 提示重新开始 |

---

## 5. 性能测试

### 5.1 响应时间测试

| 接口 | P95目标 | 测试方法 |
|------|---------|----------|
| /questionnaire/next | <500ms | 100次请求统计 |
| /match/recommendations | <1s | 100次请求统计 |
| /precheck/message | <500ms | 100次请求统计 |

### 5.2 并发测试

| 场景 | 并发数 | 预期结果 |
|------|--------|----------|
| 多用户同时问卷 | 50 | 全部正常响应 |
| 多用户同时匹配 | 50 | 全部正常响应 |
| 混合场景 | 100 | 无错误，响应时间可接受 |

### 5.3 负载测试

| 指标 | 目标 |
|------|------|
| 最大QPS | 100 |
| 内存使用 | <2GB |
| CPU使用 | <80% |

---

## 6. 测试执行计划

### 6.1 测试环境

| 环境 | 用途 | 配置 |
|------|------|------|
| 开发环境 | 开发自测 | 本地Docker |
| 测试环境 | 功能测试 | 2核4G |
| 预发布环境 | 集成/性能测试 | 4核8G |
| 生产环境 | 线上验证 | 生产配置 |

### 6.2 测试排期

| 阶段 | 时间 | 内容 |
|------|------|------|
| 单元测试 | 开发阶段 | 各模块独立测试 |
| 集成测试 | 提测后 | API+前端联调 |
| 性能测试 | 上线前 | 压测+优化 |
| 线上验证 | 上线后 | 灰度+监控 |

### 6.3 自动化测试

```python
# 示例：问卷流程自动化测试
def test_questionnaire_flow():
    # 启动问卷
    response = client.post("/api/ai/v2/questionnaire/next", json={
        "user_id": "test_user",
        "chat_history": [],
        "is_first": True
    })
    assert response.status_code == 200
    assert "next_question" in response.json()
    
    # 模拟多轮对话
    chat_history = []
    for i in range(8):
        response = client.post("/api/ai/v2/questionnaire/next", json={
            "user_id": "test_user",
            "chat_history": chat_history,
            "is_first": i == 0
        })
        chat_history.append({"role": "assistant", "text": response.json()["next_question"]})
        chat_history.append({"role": "user", "text": "测试回答"})
    
    # 验证完成
    assert response.json()["is_complete"] == True
```

---

## 7. 测试数据

### 7.1 测试用户画像

```json
{
  "perfect_match": {
    "living_space": "house_with_yard",
    "has_yard": true,
    "experience_level": "experienced",
    "daily_time_available": 5,
    "family_status": "couple"
  },
  "poor_match": {
    "living_space": "small_apartment",
    "has_yard": false,
    "experience_level": "none",
    "daily_time_available": 1,
    "family_status": "single"
  },
  "high_risk": {
    "is_renting": true,
    "landlord_allows_pets": false,
    "income_stability": "unstable",
    "work_schedule": "frequent_travel"
  }
}
```

### 7.2 测试宠物档案

```json
{
  "large_high_energy": {
    "size_category": "large",
    "energy_level": "high",
    "trainability": "difficult"
  },
  "small_low_energy": {
    "size_category": "small",
    "energy_level": "low",
    "trainability": "easy"
  }
}
```

---

**文档维护记录**

| 日期 | 版本 | 修改内容 | 作者 |
|------|------|----------|------|
| 2026-02-06 | v2.0 | 初始版本 | AI产品实习生 |
